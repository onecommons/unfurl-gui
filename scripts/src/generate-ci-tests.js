#!/usr/bin/env node

// usage: yarn run generate:gitlab-ci  > .gitlab/generated/tests.yml
const YAML = require('yaml')
const fs = require('fs')
const path = require('path')
const {unfurlGuiRoot} = require('./shared/util')

const ciTestsFileContents = fs.readFileSync(path.join(unfurlGuiRoot, '.gitlab/ci-tests.yml'), 'utf-8')
const ciTests = YAML.parse(ciTestsFileContents)


const result = {}

Object.entries(ciTests).forEach(([key, value]) => {
  const {spec, cond, env, username} = value
  result[key] = {
    'extends': '.tests',
    script: [
      `${env || ''} yarn run integration-test run ${username? `--username ${username}`: ''} --namespace $OC_NAMESPACE -- --browser chrome -s '${spec}' || exit_code=$?`,
      // timeout command exits with 124 on timeout
      'if [ $exit_code -eq 124 ]; then echo "test timed out"; fi; exit $exit_code;'
    ],
    rules: [
      { 'if': cond }
    ]
  }
})

console.log([
  '# These test workflows are generated by .gitlab/ci-tests.yml.  Do not edit this file directly.',
  YAML.stringify(result)
].join('\n'))
