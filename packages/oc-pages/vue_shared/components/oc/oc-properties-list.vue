<script>
import {mapGetters} from 'vuex'
import {GlIcon} from '@gitlab/ui'
import {Status} from 'oc_vue_shared/oc-components'
import {JSONView} from 'vue-json-component'
import Redacted from './redacted.vue'

export default {
    name: 'OcPropertiesList',
    components: {GlIcon, Status, 'json-view': JSONView, Redacted},
    data() {
        return {expanded: true}
    },
    props: {
        card: {
            type: Object,
            required: false
        },
        properties: {
            type: Array,
            required: false,
            default() {return []}
        },
        header: String,
        property: String,
        containerStyle: Object
    },
    computed: {
        ...mapGetters([
        ]),
        _properties() {
            const properties = this.property? this.card[this.property] : this.card?.template?.properties || this.card?.properties || this.properties
            return properties
        },
    },
    methods: {
        toggleExpanded() {
            this.expanded = !this.expanded
            const transitionTarget = this.$refs.transitionTarget
            if(this.expanded) {
                transitionTarget.style.marginTop = ''
            } else {
                transitionTarget.style.marginTop = `-${transitionTarget.offsetHeight}px`
            }
        },
        isUrl(value) {
            const regex = new RegExp(/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,4}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/gi)
            return regex.test(value)
        },
        isEmail(value) {
            const regex = new RegExp(/[a-z0-9]+@[a-z]+\.[a-z]{2,3}/)
            return regex.test(value)
        }
    }
}

</script>
<template>

    <div style="max-width: 100%; overflow-x: auto;">
        <div :style="containerStyle" class="properties-list-container">
            <div @click="toggleExpanded" v-if="header" class="header">
                <slot name="header-text">
                    <div>{{header}}</div>
                </slot>
                <gl-icon v-if="_properties.length" :name="expanded? 'chevron-down': 'chevron-left'" :size="18"></gl-icon>
            </div>
            <table ref="transitionTarget" class="properties-list-inner">
                <tr class="properties-list-item" v-for="property in _properties" :key="property.name">
                    <td class="name-column">{{ property.name.replaceAll('_', ' ') }}</td>
                    <td :style="property.valueStyle" class="value-column">
                        <div v-if="property.status" style="margin-left: calc(-12px - 0.25rem)">

                            <Status :status="property.status" display-text />
                        </div>
                        <div v-else style="width: 100%">
                            <div v-if="property.icon" class="icon-container">
                                <gl-icon :size="12" :name="property.icon" />
                            </div>
                            <json-view
                              v-if="property.value && typeof property.value == 'object'"
                              :data="property.value"
                              :rootKey="property.name"
                            />
                            <a v-else-if="isUrl(property.value)" :href="property.value" rel="noopener noreferrer" target="_blank" >{{ property.value }}</a>
                            <a v-else-if="isEmail(property.value)" :href="`mailto:${property.value}`" rel="noopener noreferrer" target="_blank">{{ property.value }}</a>

                            <!-- todo: use other criteria -->
                            <Redacted v-else-if="typeof property.value === 'string' && property.value.includes('REDACTED')" :value="property.value" />

                            <span v-else>
                              {{property.value}}
                            </span>
                        </div>

                        <div v-if="property.outboundLink" class="outbound-link-container d-flex">
                            <a :href="property.outboundLink" target="_blank" rel="noreferrer noopener" style="display: contents">
                                <gl-icon class="mr-1" :size="14" name="external-link"/>
                                {{__(property.outboundLinkText)}}
                            </a>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>

</template>

<style scoped>

.properties-list-container {
    border-radius: 4px;
    background-color: white;
    border-color: #d8d8d8;
    border-style: solid;
    border-width: 1px;
    display: inline-block;
    overflow: hidden;
}

.properties-list-inner {
    transition: margin 0.5s;
    width: 100%;
    table-layout: auto;
}
.properties-list-item {
    margin: -1px;
    min-width: 22em;
}
.name-column, .value-column {
    padding: 0.75em;
    border-width: 1px;
    border-color: #d8d8d8;
    border-top-style: inherit;
}
.value-column {
    display: flex;
    justify-content: space-between;
}

.properties-list-item:nth-child(n+2) {
    border-top-style: solid;
    border-width: 0;
}
.header {
    z-index: 1;
    position: relative;
    background: #fafafa;
    border-color: #d8d8d8;
    border-bottom-style: solid;
    border-width: 1px;
    padding: 0.5em;
    margin: -1px;
    font-size: 1.25em;
    display: flex;
    justify-content: space-between;
}
.name-column {
    font-weight: bold;
    background: #fafafa;
    border-top-color: white;
    border-right-style: solid;
    color: #585d60;
}
.value-column {
    padding-left: 3em; padding-right: 3em;
    color: #666666;
    border-color: #eeeeee;
    position: relative;
}
.icon-container {
    position: absolute;
    left: 1.5em;
    top: calc(50% - 8px);
    align-items: center;
}
.outbound-link-container {
    margin-right: -2em;
    margin-left: 1.5em;
    font-size: 0.9em;
}
</style>
